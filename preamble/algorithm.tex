%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%   Custom algorithm environment   %%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%
\usepackage[figure,lined,plain,linesnumbered,commentsnumbered]{algorithm2e}
\usepackage{newfloat}

% Define length to specify width of line above
% and below the algorithm environment
\newlength\algorithmtoprulewidth
\newlength\algorithmbotrulewidth
\setlength{\algorithmtoprulewidth}{0pt}
\setlength{\algorithmbotrulewidth}{\heavyrulewidth}

% Define commands to control line numbering and indention
\makeatletter
% Drop semi-colon at line end
\newcommand{\nosemic}{\renewcommand*{\@endalgocfline}{\relax}}
% Restore semi-colon
\newcommand{\dosemic}{\renewcommand*{\@endalgocfline}{\algocf@endline}}
% Indent line
\newcommand{\pushline}{\Indp}
% Do not indent line
\newcommand{\popline}{\Indm\dosemic}
% Save command for line numbering and define
% new command for suppression of numbering
\let\oldnl\nl
\newcommand{\nonl}{\renewcommand{\nl}{\let\nl\oldnl}}
\makeatother

% Define new figure-like environment for algorithms
\makeatletter
\DeclareFloatingEnvironment[%
  fileext=loalg,%
  listname={List of Algorithms},%
  name=Algorithm,%
  placement=tbp,%
  within=chapter%
]{float@algorithm@inner}

% Save definition of algorithm environment
\let\float@algorithm@old\algorithm
\let\endfloat@algorithm@old\endalgorithm

% Define new environment to replace algorithm environment
\newenvironment{float@algorithm@custom}[1][tbp]{%
  % Save definition of figure environment
  \let\float@figure@old\figure%
  \let\endfloat@figure@old\endfigure%
  % Replace figure environment
  \let\figure\float@algorithm@inner%
  \let\endfigure\endfloat@algorithm@inner%
  % Save definition of caption command
  \let\float@algorithm@caption@original\caption%
  % Renew caption command for automatic inclusion of bottom line
  \renewcommand*{\caption}{\let\caption\float@algorithm@caption@original%
    \ifdim\algorithmbotrulewidth=0pt%
      \relax%
    \else%
      \nosemic\nonl\rule{\textwidth}{\algorithmbotrulewidth}\;\dosemic%
    \fi%
    \float@algorithm@caption@original%
  }%
  % Begin saved algorithm environment
  \begin{float@algorithm@old}[#1]%
  % Draw top line
  \ifdim\algorithmtoprulewidth=0pt%
    \relax%
  \else%
    \nosemic\nonl\rule{\textwidth}{\algorithmtoprulewidth}\;\dosemic\BlankLine%
  \fi%
}{%
  % End saved algorithm environment
  \end{float@algorithm@old}%
  % Restore figure environment
  \let\figure\float@figure@old%
  \let\endfigure\endfloat@figure@old%
}

% Redefine algorithm environment
\let\algorithm\float@algorithm@custom
\let\endalgorithm\endfloat@algorithm@custom

% Setup reference names for algorithm environment
\crefname{float@algorithm@inner}{algorithm}{algorithm}
\Crefname{float@algorithm@inner}{Algorithm}{Algorithm}
\makeatother